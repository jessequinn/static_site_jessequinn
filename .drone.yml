---
kind: pipeline
type: docker
name: test

steps:
  - name: test build
    image: node:14.8.0-alpine
    commands:
      - yarn install
      - yarn build

trigger:
  branch:
    - develop
  event:
    - push
    - pull_request
---
kind: pipeline
type: docker
name: deployment

steps:
  - name: build and publish app
    image: plugins/docker
    settings:
      username:
        from_secret: repository_username
      password:
        from_secret: repository_password
      repo: damasu/jessequinn
      dockerfile: Dockerfile
      context: .
      target: prod
      build_args:
        VERSION: 14
        PORT: 3000
      tags:
        - latest
        - ${DRONE_COMMIT_SHA:0:7}
    when:
      branch:
        - master
        - develop

depends_on:
  - test

trigger:
  branch:
    - master
    - develop
  event:
    - push
    - pull_request
